<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="izumi-r2">
<meta name="generator" content="Paradox, paradox-material-theme=0.4.0, mkdocs-material=2.2.2">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.language" content="">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="izumi-r2">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>distage Staged Dependency Injection · Izumi Toolkit</title>
<link rel="stylesheet" href="../assets/stylesheets/application.7a4cdee3.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../lib/modernizr/modernizr.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
<label class="md-overlay" data-md-component="overlay" for="drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Izumi Toolkit" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Izumi Toolkit
</span>
<span class="md-header-nav__topic">
distage Staged Dependency Injection
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="search"></label>
<div class="md-search__inner">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
<label class="md-icon md-search__icon" for="search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</span>
<a href="../index.html" title="Izumi Toolkit">
Izumi Toolkit
</a>
</label>
<ul>
  <li><a href="../idealingua/index.html" class="page">IdeaLingua RPC &amp; Domain Modeling Language</a>
  <ul>
    <li><a href="../idealingua/language-reference.html" class="page">Idealingua Language Reference</a></li>
    <li><a href="../idealingua/json.html" class="page">JSON Wire Format</a></li>
    <li><a href="../idealingua/cogen.html" class="page">Code generator reference</a></li>
    <li><a href="../idealingua/cogen-circe.html" class="page">Circe serialization reference</a></li>
  </ul></li>
  <li><a href="../distage/index.html" class="active page">distage Staged Dependency Injection</a></li>
  <li><a href="../logstage/index.html" class="page">LogStage</a>
  <ul>
    <li><a href="../logstage/policy.html" class="page">Rendering policy</a></li>
    <li><a href="../logstage/config.html" class="page">logstage/config.html</a></li>
    <li><a href="../logstage/custom_ctx.html" class="page">logstage/custom_ctx.html</a></li>
  </ul></li>
  <li><a href="../sbt/index.html" class="page">SBT Toolkit</a></li>
  <li><a href="../manifesto/index.html" class="page">Productivity and challenges</a></li>
  <li><a href="../pper/index.html" class="page">PPER Pattern</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../distage/index.html#distage-staged-dependency-injection" class="header">distage Staged Dependency Injection</a>
  <ul>
    <li><a href="../distage/index.html#hello-world" class="header">Hello World</a></li>
    <li><a href="../distage/index.html#multibindings-set-bindings" class="header">Multibindings / Set Bindings</a></li>
    <li><a href="../distage/index.html#provider-bindings" class="header">Provider Bindings</a></li>
    <li><a href="../distage/index.html#tagless-final-style-with-distage" class="header">Tagless Final Style with distage</a></li>
    <li><a href="../distage/index.html#config-files" class="header">Config files</a></li>
    <li><a href="../distage/index.html#auto-factories-auto-traits" class="header">Auto-Factories &amp; Auto-Traits</a></li>
    <li><a href="../distage/index.html#patterns" class="header">Patterns</a></li>
    <li><a href="../distage/index.html#import-injection-pattern" class="header">Import Injection Pattern</a></li>
    <li><a href="../distage/index.html#depending-on-future-values-with-by-name-parameters" class="header">Depending on future values with by-name parameters</a></li>
    <li><a href="../distage/index.html#ensuring-service-boundaries-using-api-modules" class="header">Ensuring service boundaries using API modules</a></li>
    <li><a href="../distage/index.html#plugins" class="header">Plugins</a></li>
    <li><a href="../distage/index.html#roles-not-microservices" class="header">Roles, not microservices</a></li>
    <li><a href="../distage/index.html#test-kit" class="header">Test Kit</a></li>
    <li><a href="../distage/index.html#fixtures-and-utilities" class="header">Fixtures and utilities</a></li>
    <li><a href="../distage/index.html#static-configurations" class="header">Static Configurations</a></li>
    <li><a href="../distage/index.html#using-garbage-collector-to-instantiate-only-classes-required-for-the-test" class="header">Using Garbage Collector to instantiate only classes required for the test</a></li>
    <li><a href="../distage/index.html#detailed-feature-overview" class="header">Detailed Feature Overview</a></li>
    <li><a href="../distage/index.html#implicits-injection" class="header">Implicits Injection</a></li>
    <li><a href="../distage/index.html#compile-time-checks" class="header">Compile-Time Checks</a></li>
    <li><a href="../distage/index.html#circular-dependencies-support" class="header">Circular Dependencies support</a></li>
    <li><a href="../distage/index.html#auto-sets-collecting-bindings-by-predicate" class="header">Auto-Sets: Collecting Bindings By Predicate</a></li>
    <li><a href="../distage/index.html#debugging-introspection-diagnostics-and-hooks" class="header">Debugging, Introspection, Diagnostics and Hooks</a></li>
    <li><a href="../distage/index.html#extensions-and-plan-rewriting-writing-a-distage-extension" class="header">Extensions and Plan Rewriting – writing a distage extension</a></li>
    <li><a href="../distage/index.html#migrating-from-guice" class="header">Migrating from Guice</a></li>
    <li><a href="../distage/index.html#migrating-from-macwire" class="header">Migrating from MacWire</a></li>
    <li><a href="../distage/index.html#integrations" class="header">Integrations</a></li>
    <li><a href="../distage/index.html#cats" class="header">Cats</a></li>
    <li><a href="../distage/index.html#scalaz" class="header">Scalaz</a></li>
    <li><a href="../distage/index.html#freestyle" class="header">Freestyle</a></li>
    <li><a href="../distage/index.html#eff" class="header">Eff</a></li>
    <li><a href="../distage/index.html#pper" class="header">PPER</a></li>
  </ul></li>
</ul>
</nav>

<div class="md-nav__title--site md-version" title="Version">
<i class="md-icon">label_outline</i> 0.6.0*
</div>
</nav>

</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../distage/index.html#distage-staged-dependency-injection" class="header">distage Staged Dependency Injection</a>
  <ul>
    <li><a href="../distage/index.html#hello-world" class="header">Hello World</a></li>
    <li><a href="../distage/index.html#multibindings-set-bindings" class="header">Multibindings / Set Bindings</a></li>
    <li><a href="../distage/index.html#provider-bindings" class="header">Provider Bindings</a></li>
    <li><a href="../distage/index.html#tagless-final-style-with-distage" class="header">Tagless Final Style with distage</a></li>
    <li><a href="../distage/index.html#config-files" class="header">Config files</a></li>
    <li><a href="../distage/index.html#auto-factories-auto-traits" class="header">Auto-Factories &amp; Auto-Traits</a></li>
    <li><a href="../distage/index.html#patterns" class="header">Patterns</a></li>
    <li><a href="../distage/index.html#import-injection-pattern" class="header">Import Injection Pattern</a></li>
    <li><a href="../distage/index.html#depending-on-future-values-with-by-name-parameters" class="header">Depending on future values with by-name parameters</a></li>
    <li><a href="../distage/index.html#ensuring-service-boundaries-using-api-modules" class="header">Ensuring service boundaries using API modules</a></li>
    <li><a href="../distage/index.html#plugins" class="header">Plugins</a></li>
    <li><a href="../distage/index.html#roles-not-microservices" class="header">Roles, not microservices</a></li>
    <li><a href="../distage/index.html#test-kit" class="header">Test Kit</a></li>
    <li><a href="../distage/index.html#fixtures-and-utilities" class="header">Fixtures and utilities</a></li>
    <li><a href="../distage/index.html#static-configurations" class="header">Static Configurations</a></li>
    <li><a href="../distage/index.html#using-garbage-collector-to-instantiate-only-classes-required-for-the-test" class="header">Using Garbage Collector to instantiate only classes required for the test</a></li>
    <li><a href="../distage/index.html#detailed-feature-overview" class="header">Detailed Feature Overview</a></li>
    <li><a href="../distage/index.html#implicits-injection" class="header">Implicits Injection</a></li>
    <li><a href="../distage/index.html#compile-time-checks" class="header">Compile-Time Checks</a></li>
    <li><a href="../distage/index.html#circular-dependencies-support" class="header">Circular Dependencies support</a></li>
    <li><a href="../distage/index.html#auto-sets-collecting-bindings-by-predicate" class="header">Auto-Sets: Collecting Bindings By Predicate</a></li>
    <li><a href="../distage/index.html#debugging-introspection-diagnostics-and-hooks" class="header">Debugging, Introspection, Diagnostics and Hooks</a></li>
    <li><a href="../distage/index.html#extensions-and-plan-rewriting-writing-a-distage-extension" class="header">Extensions and Plan Rewriting – writing a distage extension</a></li>
    <li><a href="../distage/index.html#migrating-from-guice" class="header">Migrating from Guice</a></li>
    <li><a href="../distage/index.html#migrating-from-macwire" class="header">Migrating from MacWire</a></li>
    <li><a href="../distage/index.html#integrations" class="header">Integrations</a></li>
    <li><a href="../distage/index.html#cats" class="header">Cats</a></li>
    <li><a href="../distage/index.html#scalaz" class="header">Scalaz</a></li>
    <li><a href="../distage/index.html#freestyle" class="header">Freestyle</a></li>
    <li><a href="../distage/index.html#eff" class="header">Eff</a></li>
    <li><a href="../distage/index.html#pper" class="header">PPER</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#distage-staged-dependency-injection" name="distage-staged-dependency-injection" class="anchor"><span class="anchor-link"></span></a>distage Staged Dependency Injection</h1>
<p>distage is a modern dependency injection framework for Scala.</p>
<p>Combining type safety, ease composition and separation of declaration from execution from FP, and late binding, modularity and scalability from OOP, distage brings together a fusion that retains safety and clarity of pure FP without sacrificing full runtime flexibility and configurability of traditional runtime dependency injection frameworks such as Guice.</p>
<h3><a href="#hello-world" name="hello-world" class="anchor"><span class="anchor-link"></span></a>Hello World</h3>
<p>This is what Hello World looks like in distage:</p>
<pre class="prettyprint"><code class="language-scala">import distage._

class Hello {
  def hello(name: String) = println(s&quot;Hello $name!&quot;)
}

object HelloModule extends ModuleDef {
  make[Hello]
}

object Main extends App {
  val injector = Injector()

  val plan = injector.plan(HelloModule)

  val classes: Locator = injector.produce(plan)

  println(&quot;What&#39;s your name?&quot;)
  val name = readLine()
  
  classes.get[Hello].hello(name)
}
</code></pre>
<p>Let&rsquo;s take a closer look:</p>
<pre class="prettyprint"><code class="language-scala">object HelloModule extends ModuleDef {
  make[Hello]
}
</code></pre>
<p>We define a <em>Module</em> for our application. A module specifies <em>what</em> classes to instantiate and <em>how</em> to instantiate them.</p>
<p>In this case we are using the default instantiation strategy - just calling the constructor.</p>
<p>If a constructor accepts arguments, distage will first instantiate the arguments, then call the constructor. All the classes in distage are instantiated exactly once, even if multiple different classes depend on them, in other words they are <code>Singletons</code>.</p>
<p>Modules can be combined using <code>++</code> operator, for example we can join our <code>HelloModule</code> with a <code>ByeModule</code>:</p>
<pre class="prettyprint"><code class="language-scala">object ByeModule extends ModuleDef {
  make[Bye]
}

class Bye {
  def bye(name: String) = println(s&quot;Bye $name!&quot;)
}

val helloBye = HelloModule ++ ByeModule
</code></pre>
<p>Combining modules with <code>++</code> is the main way to assemble your app together! But, if you don&rsquo;t want to list all your modules in one place, you can use <a href="#plugins">Plugins</a> to automatically discover all the (marked) modules in your app.</p>
<p>If you choose to combine your modules manually, distage offers compile-time checks ensuring that your app will start. See <a href="#static-configurations">Static Configurations</a> for details.</p>
<pre class="prettyprint"><code class="language-scala">object Main extends App {
  val injector = Injector()
  val plan = injector.plan(HelloModule)
</code></pre>
<p>We create an instantation <code>plan</code> from the module definition. distage is <em>staged</em>, so instead of instantiating our definitions right away, distage first builds a pure representation of all the operations it will do and returns it back to us.</p>
<p>This allows us to easily implement additional functionality on top of distage without modifying the library. In fact, distage&rsquo;s built-in functionality such as <a href="#plugins">Plugins</a> and <a href="#config-files">Configurations</a> is not hard-wired, but is built on this framework of manipulating the <code>plan</code>. Plan rewriting also enables the <a href="#import-injection-pattern">Import Injection Pattern</a> that helps limit side effects during initialization. </p>
<pre class="prettyprint"><code class="language-scala">  val classes: Locator = injector.produce(plan)

  classes.get[Hello].helloWorld()
</code></pre>
<p>After we execute the plan we&rsquo;re left a <code>Locator</code> that holds all of our app&rsquo;s classes. We can retrieve the instances by type using the <code>.get</code> method</p>
<h3><a href="#multibindings-set-bindings" name="multibindings-set-bindings" class="anchor"><span class="anchor-link"></span></a>Multibindings / Set Bindings</h3>
<p>Multibindings are useful for implementing event listeners, plugins, hooks, http routes, etc.</p>
<p>To define a multibinding use <code>.many</code> and <code>.add</code> methods in <a href="/api/com/github/pshirshov/izumi/distage/model/definition/ModuleDef.html">ModuleDef</a> DSL:</p>
<pre class="prettyprint"><code class="language-scala">import cats.effect._, org.http4s._, org.http4s.dsl.io._, scala.concurrent.ExecutionContext.Implicits.global
import distage._

object HomeRouteModule extends ModuleDef {
  many[HttpRoutes[IO]].add {
    HttpRoutes.of[IO] { case GET -&gt; Root / &quot;home&quot; =&gt; Ok(s&quot;Home page!&quot;) }
  }
}
</code></pre>
<p>Multibindings defined in different modules will be merged together into a single Set. You can summon a multibinding by type <code>Set[_]</code>:</p>
<pre class="prettyprint"><code class="language-scala">import cats.implicits._, import org.http4s.server.blaze._, import org.http4s.implicits._

object BlogRouteModule extends ModuleDef {
  many[HttpRoutes[IO]].add {
    HttpRoutes.of[IO] { case GET -&gt; Root / &quot;blog&quot; / post =&gt; Ok(&quot;Blog post ``$post&#39;&#39;!&quot;) }
  }
}

class HttpServer(routes: Set[HttpRoutes[IO]]) {
  def serve = BlazeBuilder[IO]
    .bindHttp(8080, &quot;localhost&quot;)
    .mountService(routes.fold[HttpRoutes[IO]], &quot;/&quot;)
    .start

  val count = routes.size
}

val context = Injector().run(HomeRouteModule ++ BlogRouteModule)
val server = context.get[HttpServer]

server.count // 2
</code></pre>
<p>For further detail see <a href="https://github.com/google/guice/wiki/Multibindings">Guice wiki on Multibindings</a>.</p>
<h3><a href="#provider-bindings" name="provider-bindings" class="anchor"><span class="anchor-link"></span></a>Provider Bindings</h3>
<p>To bind to a function instead of constructor use <code>.from</code> method in <a href="/api/com/github/pshirshov/izumi/distage/model/definition/ModuleDef.html">ModuleDef</a> DSL:</p>
<pre class="prettyprint"><code class="language-scala">case class HostPort(host: String, port: Int)

class HttpServer(hostPort: HostPort)

trait HttpServerModule extends ModuleDef {
  make[HttpServer].from {
    hostPort: HostPort =&gt; new HttpServer(hostPort.host, hostPort + 1000)
  }
}
</code></pre>
<p>To inject named instances or config values, add annotations to lambda arguments&rsquo; types:</p>
<pre class="prettyprint"><code class="language-scala">trait HostPortModule extends ModuleDef {
  make[HostPort].from {
    (configHost: String @ConfPath(&quot;http.host&quot;), configPort: Int @ConfPath(&quot;http.port&quot;)) =&gt;
      HostPort(configHost, configPort)
  }
}
</code></pre>
<p>For further details, see scaladoc for <a href="/api/com/github/pshirshov/izumi/distage/model/providers/ProviderMagnet.html">ProviderMagnet</a></p>
<h3><a href="#tagless-final-style-with-distage" name="tagless-final-style-with-distage" class="anchor"><span class="anchor-link"></span></a>Tagless Final Style with distage</h3>
<p>distage has first-class support for tagless final style. Let&rsquo;s see what <a href="http://frees.io/docs/core/handlers/#tagless-interpretation">freestyle tagless example</a> looks like in distage:</p>
<pre class="prettyprint"><code class="language-scala">class Program[F: TagK: Monad] extends ModuleDef {
  make[TaglessProgram[F]]
}

object TryInterpreters extends ModuleDef {
  make[Validation.Handler[Try]].from(tryValidationHandler)
  make[Interaction.Handler[Try]].from(tryInteractionHandler)
}

// Combine modules into a full program
val TryProgram = new Program[Try] ++ TryInterpreters
</code></pre>
<p>where</p>
<pre class="prettyprint"><code class="language-scala">class TaglessProgram[F[_]: Monad](validation: Validation[F], interaction: Interaction[F]) {
  def program = for {
      userInput &lt;- interaction.ask(&quot;Give me something with at least 3 chars and a number on it&quot;)
      valid     &lt;- (validation.minSize(userInput, 3), validation.hasNumber(userInput)).mapN(_ &amp;&amp; _)
      _         &lt;- if (valid) interaction.tell(&quot;awesomesauce!&quot;) else interaction.tell(s&quot;$userInput is not valid&quot;)
  } yield ()
}

val validationHandler = new Validation.Handler[Try] {
  override def minSize(s: String, n: Int): Try[Boolean] = Try(s.size &gt;= n)
  override def hasNumber(s: String): Try[Boolean] = Try(s.exists(c =&gt; &quot;0123456789&quot;.contains(c)))
}

val interactionHandler = new Interaction.Handler[Try] {
  override def tell(s: String): Try[Unit] = Try(println(s))
  override def ask(s: String): Try[String] = Try(&quot;This could have been user input 1&quot;)
}
</code></pre>
<p>Notice how the program module stays completely polymorphic and abstracted from its eventual interpeter or the monad it will run in? Want a program in different Monad? No problem:</p>
<pre class="prettyprint"><code class="language-scala">val IOProgram = new Program[IO] ++ IOInterpreters
</code></pre>
<p>Want a program in the <strong>same</strong> Monad, but with different interpreters? No problem either:</p>
<pre class="prettyprint"><code class="language-scala">val DifferentTryProgram = new Program[Try] ++ DifferentTryInterpreters
</code></pre>
<p>distage makes tagless final style easier and safer by making your implicit instances explicit and configurable as first-class values. It even enforces typeclass coherence by disallowing multiple instances, so one wrong <code>import</code> can&rsquo;t ruin your day. distage doesn&rsquo;t make you choose between OO and FP, it lets you use both without losing neither ease of configuration and variability of a runtime DI framework, nor parametricity and equational reasoning of pure FP style.</p>
<h3><a href="#config-files" name="config-files" class="anchor"><span class="anchor-link"></span></a>Config files</h3>
<p>We provide first-class integration with <code>typesafe-config</code>, rendering a lot of parsing boilerplate unnecessary.</p>
<p>To use it, add <code>distage-config</code> library:</p>
<pre class="prettyprint"><code class="language-scala">libraryDependencies += Izumi.R.distage_config
</code></pre>
<p>or</p>
<pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;com.github.pshirshov.izumi.r2&quot; %% &quot;distage-config&quot; % &quot;0.6.0-SNAPSHOT&quot;
</code></pre>
<p>If you&rsquo;re not using <a href="sbt/00_sbt.md#bills-of-materials">sbt-izumi-deps</a> plugin.</p>
<p>Write a config in HOCON format:</p>
<pre class="prettyprint"><code class="language-hocon"># resources/application.conf
program {
    config {
        different = true
    }
}
</code></pre>
<p>Add <code>ConfigModule</code> to your injector:</p>
<pre class="prettyprint"><code class="language-scala">import distage.config._
import com.typesafe.config.ConfigFactory

val config = ConfigFactory.load()

val injector = Injector(new ConfigModule(AppConfig(config)))
</code></pre>
<p>Now you can automatically parse config entries into case classes and can summon them from any class:</p>
<pre class="prettyprint"><code class="language-scala">final case class Config(different: Boolean)

class ConfiguredTaglessProgram[F](
  @ConfPath(&quot;program.config&quot;) config: Config,
  @Id(&quot;primary&quot;) primaryProgram: TaglessProgram[F],
  @Id(&quot;different&quot;) differentProgram: TaglessProgram[F]) {

    val program = if (config.different) differentProgram else primaryProgram
}

class ConfiguredTryProgram[F: TagK: Monad] extends ModuleDef {
  make[ConfiguredProgram[F]]
  make[TaglessProgram[F]].named(&quot;primary&quot;)
  make[TaglessProgram[F]].named(&quot;different&quot;)
}
</code></pre>
<h3><a href="#auto-factories-auto-traits" name="auto-factories-auto-traits" class="anchor"><span class="anchor-link"></span></a>Auto-Factories &amp; Auto-Traits</h3>
<p>&hellip;</p>
<h3><a href="#patterns" name="patterns" class="anchor"><span class="anchor-link"></span></a>Patterns</h3>
<h3><a href="#import-injection-pattern" name="import-injection-pattern" class="anchor"><span class="anchor-link"></span></a>Import Injection Pattern</h3>
<p>&hellip;</p>
<h3><a href="#depending-on-future-values-with-by-name-parameters" name="depending-on-future-values-with-by-name-parameters" class="anchor"><span class="anchor-link"></span></a>Depending on future values with by-name parameters</h3>
<p>&hellip;</p>
<h3><a href="#ensuring-service-boundaries-using-api-modules" name="ensuring-service-boundaries-using-api-modules" class="anchor"><span class="anchor-link"></span></a>Ensuring service boundaries using API modules</h3>
<p>&hellip;</p>
<h3><a href="#plugins" name="plugins" class="anchor"><span class="anchor-link"></span></a>Plugins</h3>
<p>Sometimes, when rapidly prototyping, the additional friction of adding new modules into the system can disrupt developer&rsquo;s flow. Distage plugin system can automatically pickup all modules defined in the program and by doing that reduce friction of adding new modules.</p>
<p>To define a plugin, first add distage-plugins library:</p>
<pre class="prettyprint"><code class="language-scala">libraryDependencies += Izumi.R.distage_plugins
</code></pre>
<p>or</p>
<pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;com.github.pshirshov.izumi.r2&quot; %% &quot;distage-plugins&quot; % &quot;0.6.0-SNAPSHOT&quot;
</code></pre>
<p>If you&rsquo;re not using <a href="sbt/00_sbt.md#bills-of-materials">sbt-izumi-deps</a> plugin.</p>
<p>Create a module extending the <code>PluginDef</code> trait instead of <code>ModuleDef</code>:</p>
<pre class="prettyprint"><code class="language-scala">trait PetStorePlugin extends PluginDef {
  make[PetRepository]
  make[PetStoreService]
  make[PetStoreController]
}
</code></pre>
<p>At your app entry point add a plugin loader:</p>
<pre class="prettyprint"><code class="language-scala">val pluginLoader = new PluginLoaderDefaultImpl(
  PluginConfig(debug = false, packagesEnabled = Seq(&quot;com.example&quot;), packagesDisabled = Seq.empty))
)

val appModules = pluginLoader.load()
val app = appModules.merge
</code></pre>
<p>Launch as normal with the loaded modules:</p>
<pre class="prettyprint"><code class="language-scala">val injector = Injector()
injector.run(app)
</code></pre>
<p>Plugins also allow a program to dynamically extend itself by adding new Plugin classes into the classpath which will be picked up at runtime.</p>
<h3><a href="#roles-not-microservices" name="roles-not-microservices" class="anchor"><span class="anchor-link"></span></a>Roles, not microservices</h3>
<p>&hellip;</p>
<h3><a href="#test-kit" name="test-kit" class="anchor"><span class="anchor-link"></span></a>Test Kit</h3>
<h3><a href="#fixtures-and-utilities" name="fixtures-and-utilities" class="anchor"><span class="anchor-link"></span></a>Fixtures and utilities</h3>
<p>&hellip;</p>
<h3><a href="#static-configurations" name="static-configurations" class="anchor"><span class="anchor-link"></span></a>Static Configurations</h3>
<p>&hellip;</p>
<h3><a href="#using-garbage-collector-to-instantiate-only-classes-required-for-the-test" name="using-garbage-collector-to-instantiate-only-classes-required-for-the-test" class="anchor"><span class="anchor-link"></span></a>Using Garbage Collector to instantiate only classes required for the test</h3>
<p>&hellip;</p>
<h3><a href="#detailed-feature-overview" name="detailed-feature-overview" class="anchor"><span class="anchor-link"></span></a>Detailed Feature Overview</h3>
<h3><a href="#implicits-injection" name="implicits-injection" class="anchor"><span class="anchor-link"></span></a>Implicits Injection</h3>
<p>&hellip;</p>
<h4><a href="#typeclass-coherence-guarantees" name="typeclass-coherence-guarantees" class="anchor"><span class="anchor-link"></span></a>Typeclass Coherence Guarantees</h4>
<h3><a href="#compile-time-checks" name="compile-time-checks" class="anchor"><span class="anchor-link"></span></a>Compile-Time Checks</h3>
<p>&hellip;</p>
<h3><a href="#circular-dependencies-support" name="circular-dependencies-support" class="anchor"><span class="anchor-link"></span></a>Circular Dependencies support</h3>
<p>&hellip;</p>
<h4><a href="#automatic-resolution-with-generated-proxies" name="automatic-resolution-with-generated-proxies" class="anchor"><span class="anchor-link"></span></a>Automatic Resolution with generated Proxies</h4>
<h4><a href="#manual-resolution-with-by-name-parameters" name="manual-resolution-with-by-name-parameters" class="anchor"><span class="anchor-link"></span></a>Manual Resolution with by-name parameters</h4>
<h3><a href="#auto-sets-collecting-bindings-by-predicate" name="auto-sets-collecting-bindings-by-predicate" class="anchor"><span class="anchor-link"></span></a>Auto-Sets: Collecting Bindings By Predicate</h3>
<p>&hellip;</p>
<h4><a href="#weak-sets" name="weak-sets" class="anchor"><span class="anchor-link"></span></a>Weak Sets</h4>
<h3><a href="#debugging-introspection-diagnostics-and-hooks" name="debugging-introspection-diagnostics-and-hooks" class="anchor"><span class="anchor-link"></span></a>Debugging, Introspection, Diagnostics and Hooks</h3>
<p>You can print a <code>plan</code> to get detailed info on what will happen during instantiation. The printout includes file:line info so your IDE can show you where the binding was defined! </p>
<pre class="prettyprint"><code class="language-scala">System.err.println(plan: OrderedPlan)
</code></pre>
<p><img src="media/print-test-plan.png" alt="print-test-plan" /></p>
<p>You can also query a plan to see the dependencies and reverse dependencies of a class and their instantiation:</p>
<pre class="prettyprint"><code class="language-scala">// Print dependencies
System.err.println(plan.topology.dependencies.tree(DIKey.get[Circular1]))
// Print reverse dependencies
System.err.println(plan.topology.dependees.tree(DIKey.get[Circular1]))
</code></pre>
<p><img src="media/print-dependencies.png" alt="print-dependencies" /></p>
<p>The printer highlights circular dependencies.</p>
<p>Distage also uses some macros, macros are currently used to create <code>TagK</code>s and <a href="#provider-bindings">provider bindings</a>. If you think they&rsquo;ve gone awry, you can turn macro debug output during compilation by setting <code>-Dizumi.distage.debug.macro=true</code> java property:</p>
<pre class="prettyprint"><code class="language-bash">sbt -Dizumi.distage.debug.macro=true compile
</code></pre>
<p>Macros power <code>distage-static</code> module, an alternative backend that doesn&rsquo;t use JVM runtime reflection.</p>
<h3><a href="#extensions-and-plan-rewriting-writing-a-distage-extension" name="extensions-and-plan-rewriting-writing-a-distage-extension" class="anchor"><span class="anchor-link"></span></a>Extensions and Plan Rewriting – writing a distage extension</h3>
<p>&hellip;</p>
<h3><a href="#migrating-from-guice" name="migrating-from-guice" class="anchor"><span class="anchor-link"></span></a>Migrating from Guice</h3>
<p>&hellip;</p>
<h3><a href="#migrating-from-macwire" name="migrating-from-macwire" class="anchor"><span class="anchor-link"></span></a>Migrating from MacWire</h3>
<p>&hellip;</p>
<h3><a href="#integrations" name="integrations" class="anchor"><span class="anchor-link"></span></a>Integrations</h3>
<p>&hellip;</p>
<h3><a href="#cats" name="cats" class="anchor"><span class="anchor-link"></span></a>Cats</h3>
<p>To import cats integration add distage-cats library:</p>
<pre class="prettyprint"><code class="language-scala">libraryDependencies += Izumi.R.distage_cats
</code></pre>
<p>or</p>
<pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;com.github.pshirshov.izumi.r2&quot; %% &quot;distage-cats&quot; % &quot;0.6.0-SNAPSHOT&quot;
</code></pre>
<p>If you&rsquo;re not using <a href="sbt/00_sbt.md#bills-of-materials">sbt-izumi-deps</a> plugin.</p>
<p>Usage:</p>
<pre class="prettyprint"><code class="language-scala">import cats.implicits._
import cats.effect._
import distage._
import distage.cats._

object Main extends IOApp {
  def run(args: List[String]): IO[Unit] = {
    val myModules = module1 |+| module2 // Monoid instance is available for ModuleDef
    
    for { 
      classes &lt;- Injector().runIO[IO](myModules)
      _ &lt;- classes.get[AppEntrypoint].run
    } yield ()
  }
}
</code></pre>
<h3><a href="#scalaz" name="scalaz" class="anchor"><span class="anchor-link"></span></a>Scalaz</h3>
<h3><a href="#freestyle" name="freestyle" class="anchor"><span class="anchor-link"></span></a>Freestyle</h3>
<h3><a href="#eff" name="eff" class="anchor"><span class="anchor-link"></span></a>Eff</h3>
<h2><a href="#pper" name="pper" class="anchor"><span class="anchor-link"></span></a>PPER</h2>
<p>See <a href="../pper/index.html">PPER Overview</a></p>
</div>
<div>
<a href="https://github.com/pshirshov/izumi-r2/tree/master/doc/paradox/distage/00_distage.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.6.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../idealingua/cogen-circe.html" title="Circe serialization reference" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Circe serialization reference
</span>
</div>
</a>
<a href="../logstage/index.html" title="LogStage" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
LogStage
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.5165553b.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
